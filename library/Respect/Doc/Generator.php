<?php
namespace Respect\Doc;

use \SplObjectStorage;
use \ReflectionClass;
use \ReflectionMethod;
use \ReflectionProperty;

/**
 * Generates documentation that rocks your socks off.
 * 
 * Why it rock your socks off:
 * 
 *   1. Tested code rocks! So it uses PHPUnit Test Cases to know how your code works.
 *   2. Doc comments, like these, are really optional.
 *   3. This very documentation was generated by the class itself.
 * 
 * @author  Alexandre Gaigalas <alexandre@gaigalas.net>
 * @author  Augusto Pascutti <augusto@phpsp.org.br>
 */
class Generator
{
	protected $ns;
	protected $reflections=array();
	protected $sections=array();

	/** Receives the class name to be documented. */
	public function __construct($classname)
	{
		$this->ns = $classname;
	}

	/** Returns the documentation in markdown */
	public function __toString()
	{
		$sections = array();
		$md       = '';
		return $this->getMarkdown($this->getContents());
		
	}

	//TODO: extract a lot of methods
	protected function getContents()
	{
		$path = $this->ns;

		if (!class_exists($path))
			return array();

		$sections = array();
		$classes  = array($path);
		foreach ($classes as $class) {
			$reflection       = new ReflectionClass($class);
			$class            = $reflection->getName();
			$sections[$class] = $reflection->getDocComment();

			$reflectors = $this->getSections($reflection);
			foreach ($reflectors as $sub) {

				$tests = $reflectors[$sub];

				if ($sub->isStatic())
					$subName = 'static ';
				else
					$subName = '';

				$subName .= $sub->getName();
				$name     = $class.'::'.$subName;

				if ($sub instanceof ReflectionMethod)
					if ($sub->getNumberOfRequiredParameters() <= 0)
						$name .= '()';
					else {
						$params = $sub->getParameters();
						$tmp    = array();
						foreach ($params as $param) {
							if ($param->isArray())
								$tmp[] = 'array ';
							if ($param->isOptional())
								$tmp[] = '$'.$param->getName().'=null';
							elseif ($param->isDefaultValueAvailable())
								$tmp[] = '$'.$param->getName().'='.$param->getDefaultValue();
							else
								$tmp[] = '$'.$param->getName();
						}
						$name .= '('.implode(', ', $tmp).')';
					}
					
				$sections[$name] = $sub->getDocComment();
				// Fetch method content for examples
				foreach ($tests as $test) {
					$testCaseContents = file($test->getFilename());
					$testCaseLines    = array_slice($testCaseContents, 1+$test->getStartLine(), -2+$test->getEndLine()-$test->getStartLine());
					$testCaseLines    = array_map(function($line) {
											return '    '.ltrim($line);
										}, $testCaseLines);
					$sections[$name] .= PHP_EOL.PHP_EOL.implode($testCaseLines);
				}

			}
				
		}
		return $sections;
	}

	protected function getSections(ReflectionClass $reflection) 
	{
		$testCaseClass = $reflection->getName().'Test';

		if (class_exists($testCaseClass)) {
			$testCaseReflection = new ReflectionClass($testCaseClass);
			$testCaseMethods = $testCaseReflection->getMethods();
		} else {
			$testCaseMethods= array();
		}
		$sections = new SplObjectStorage;
		$methods = $reflection->getMethods(ReflectionMethod::IS_PUBLIC ^ ReflectionMethod::IS_STATIC);
		$properties = $reflection->getProperties(ReflectionProperty::IS_PUBLIC ^ ReflectionProperty::IS_STATIC);
		$staticMethods = $reflection->getMethods(ReflectionMethod::IS_PUBLIC & ReflectionMethod::IS_STATIC);
		$staticProperties = $reflection->getProperties(ReflectionProperty::IS_PUBLIC & ReflectionProperty::IS_STATIC);

		$nameSort = function($a, $b) {
			return strnatcasecmp($a->getName(), $b->getName());
		};

		usort($methods, $nameSort);
		usort($properties, $nameSort);
		usort($staticMethods, $nameSort);
		usort($staticProperties, $nameSort);
		foreach (array_merge($staticProperties, $properties, $staticMethods, $methods) as $method)
			$sections[$method] = array_filter($testCaseMethods, function($test) use($method) {
									return $test->getName() == 'test_as_example_for_'.$method->getName().'_method';
							     });
		return $sections;
	}

	protected function getMarkdown(array $sections)
	{
		$string = array();
		foreach ($sections as $name=>$content) {
			
			if (preg_match_all('/[\:]{1,2}(.*)/', $name, $matches))
				$name = $matches[1][0];
			else 
				$matches = 1;

			$content  = trim(preg_replace('#^(\s*[*]|[/][*]{2}|[\][*])[/*]*(.*?)[ /*]*$#m', '$2', $content));
			$content  = preg_replace('#^[@](\w+)\s+(.*)#', '  - **$1**: $2 ', $content);
			$string[] = trim(str_repeat('#', count($matches)).' '.$name."\n\n".$content);
		}
		return implode("\n\n", $string);
	}
}